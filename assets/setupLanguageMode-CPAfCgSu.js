import{n as l,R as p,M as f,o as m}from"./index-Bpq67avY.js";import"./antd-Sqqp5mxm.js";import"./lodash-aGR4VZ5D.js";import"./prettier-y3XyMyrW.js";import"./chance-DnaHbaGl.js";const k=2*60*1e3;class C{constructor(e){this._defaults=e,this._worker=null,this._client=null,this._idleCheckInterval=window.setInterval(()=>this._checkIfIdle(),30*1e3),this._lastUsedTime=0,this._configChangeListener=this._defaults.onDidChange(()=>this._stopWorker())}_stopWorker(){this._worker&&(this._worker.dispose(),this._worker=null),this._client=null}dispose(){clearInterval(this._idleCheckInterval),this._configChangeListener.dispose(),this._stopWorker()}_checkIfIdle(){if(!this._worker)return;Date.now()-this._lastUsedTime>k&&this._stopWorker()}_getClient(){return this._lastUsedTime=Date.now(),this._client||(this._worker=l.createWebWorker({moduleId:this._defaults.languageId,label:this._defaults.languageId,createData:{languageId:this._defaults.languageId}}),this._client=this._worker.getProxy()),this._client}getLanguageServiceWorker(...e){const s=e?.filter(Boolean);return this._getClient().then(n=>(s&&s?.length&&this._worker&&this._worker.withSyncedResources(s),n))}}function w(r,e,s){let n=null;return(...o)=>{n&&clearTimeout(n),n=setTimeout(()=>{n&&clearTimeout(n),n=null,r?.(...o)},e)}}class I{constructor(e,s,n){this._languageId=e,this._worker=s,this._defaults=n,this._disposables=[],this._listener=Object.create(null);const o=t=>{let i=t.getLanguageId();i===this._languageId&&(this._listener[t.uri.toString()]=t.onDidChangeContent(w(()=>{this._doValidate(t.uri,i)},500)),this._doValidate(t.uri,i))},a=t=>{l.setModelMarkers(t,this._languageId,[]);let i=t.uri.toString(),d=this._listener[i];d&&(d.dispose(),delete this._listener[i])};this._disposables.push(l.onDidCreateModel(o)),this._disposables.push(l.onWillDisposeModel(a)),this._disposables.push(l.onDidChangeModelLanguage(t=>{a(t.model),o(t.model)})),this._disposables.push(this._defaults.onDidChange(t=>{l.getModels().forEach(i=>{i.getLanguageId()===this._languageId&&(a(i),o(i))})})),this._disposables.push({dispose:()=>{for(let t in this._listener)this._listener[t].dispose()}}),l.getModels().forEach(o)}dispose(){this._disposables.forEach(e=>e&&e.dispose()),this._disposables=[]}_doValidate(e,s){this._worker(e).then(n=>{var o;let a=((o=l.getModel(e))===null||o===void 0?void 0:o.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(a=this._defaults.preprocessCode(a)),n.doValidation(a)}).then(n=>{const o=n.map(t=>v(e,t));let a=l.getModel(e);a&&a.getLanguageId()===s&&l.setModelMarkers(a,s,o)}).then(void 0,n=>{console.error(n)})}}function b(r){switch(r){default:return f.Error}}function v(r,e){return{severity:b(),startLineNumber:e.startLine,startColumn:e.startColumn,endLineNumber:e.endLine,endColumn:e.endColumn,message:e.message,code:void 0,source:"dt-sql-parser"}}class M{constructor(e,s){this._worker=e,this._defaults=s}get triggerCharacters(){return Array.isArray(this._defaults.triggerCharacters)?this._defaults.triggerCharacters:["."," "]}provideCompletionItems(e,s,n,o){const a=e.uri;return this._worker(a).then(t=>{var i;let d=((i=l.getModel(a))===null||i===void 0?void 0:i.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(d=this._defaults.preprocessCode(d)),t.doCompletionWithEntities(d,s)}).then(([t,i])=>this._defaults.completionService(e,s,n,t,i)).then(t=>{const i=e.getWordUntilPosition(s),d=new p(s.lineNumber,i.startColumn,s.lineNumber,i.endColumn);return{suggestions:(Array.isArray(t)?t:t.suggestions).map(u=>{var h,g;return Object.assign(Object.assign({},u),{insertText:(h=u.insertText)!==null&&h!==void 0?h:typeof u.label=="string"?u.label:u.label.label,range:(g=u.range)!==null&&g!==void 0?g:d})}),dispose:Array.isArray(t)?void 0:t.dispose,incomplete:Array.isArray(t)?void 0:t.incomplete}})}}function E(r){const e=[],s=[],n=new C(r);e.push(n);const o=(...t)=>n.getLanguageServiceWorker(...t);function a(){const{languageId:t,modeConfiguration:i}=r;_(s),i.diagnostics&&s.push(new I(t,o,r)),i.completionItems.enable&&s.push(m.registerCompletionItemProvider(t,new M(o,r)))}return a(),e.push(c(s)),c(e)}function c(r){return{dispose:()=>_(r)}}function _(r){for(var e;r.length;)(e=r.pop())===null||e===void 0||e.dispose()}export{E as setupLanguageMode};
